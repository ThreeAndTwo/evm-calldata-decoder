// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/kyberswap/KyberRouterV2SwapDecoder.sol";

contract KyberRouterV2SwapDecoderTest is Test {
    
    function setUp() public {
    }

    function testSwap() public {
        // https://etherscan.io/tx/0xa6867b46a4438c07f42b5bee08f2e9872f8e7d9cf1127d353768ba7cb8c84cb2
        bytes memory swapCalldata = hex"e21fd0e90000000000000000000000000000000000000000000000000000000000000020000000000000000000000000f081470f5c6fbccf48cc4e5b82dd926409dcdd67000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000019e00000000000000000000000000000000000000000000000000000000000001c200000000000000000000000000000000000000000000000000000000000001920000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000007fc66500c84a76ad7e9c93437bfc5ac33e2ddae9000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000de6b2a06407575b98724818445178c1f5fd533610000000000000000000000000000000000000000000000000000000067650a7900000000000000000000000000000000000000000000000000000000000018c0000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000004600000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000f800000000000000000000000000000000000000000000000000000000000001460000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000000408cc7a56b0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c83de27efa2f1aa663ae5d458857e731c129069f290002000000000000000005880000000000000000000000007fc66500c84a76ad7e9c93437bfc5ac33e2ddae90000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca000000000000000000000000000000000000000000000000821ab0d441498000000000000000000000000000000000000000000000000000000000000000000408cc7a56b0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c893d199263632a4ef4bb438f1feb99e57b4b5f0bd0000000000000000000005c20000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000a0c582519ddb3b95000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000f081470f5c6fbccf48cc4e5b82dd926409dcdd6700000000000000000000000011b815efb8f581194ae79006d24e0d814b7697f6000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000bed3f1c3498f850d000000000000000000000000000000000000000000000000000000010009046c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000004e000000000000000000000000000000000000000000000000000000000000000408934ba230000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000111111125421ca6dc452d289314280a0f8842a65000000000000000000000000000000000000000000000001a055690d9db8000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000005617836ce1954b561e8ae0c200000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000007fc66500c84a76ad7e9c93437bfc5ac33e2ddae900000000000000000000000000000000000000000000000026323e673919c490000000000000000000000000000000000000000000000001a055690d9db80000000000000000000000000000000099070600676506064e5b82dd926409dcdd6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000040ef25f33c084f621152b7a4482709870bc4bc59682390f950a50a7855793fefdf4cdb2921d2e7f3d74ad4d651fa189c9cc8108967643296eec1a9f24821a347300000000000000000000000000000000000000000000000000000000000000014f081470f5c6fbccf48cc4e5b82dd926409dcdd67000000000000000000000000000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000f081470f5c6fbccf48cc4e5b82dd926409dcdd670000000000000000000000004585fe77225b41b697c938b018e2ac67ac5a20c0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000000000000000000000000000262b1dc6d5209e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000f081470f5c6fbccf48cc4e5b82dd926409dcdd6700000000000000000000000056534741cd8b152df6d48adf7ac51f75169a83b20000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000920bef0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000000408934ba230000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000111111125421ca6dc452d289314280a0f8842a65000000000000000000000000000000000000000000000003cb71f51fc5580000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000029230dfcfbc010d06f13e29900000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000007fc66500c84a76ad7e9c93437bfc5ac33e2ddae9000000000000000000000000000000000000000000000000590d753713fd6710000000000000000000000000000000000000000000000003cb71f51fc5580000000000000000000000000000000099070500676506064e5b82dd926409dcdd6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000040d803684642250d1f70d08c4e8c837aceb09ceab76387192939ee1c7e2247f42447fcc4376cf6c9abbf45ffac318beb8c56c168b5ca98bc38379af92080a30b0d0000000000000000000000000000000000000000000000000000000000000014f081470f5c6fbccf48cc4e5b82dd926409dcdd67000000000000000000000000000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000f081470f5c6fbccf48cc4e5b82dd926409dcdd670000000000000000000000006ca298d2983ab03aa1da7679389d955a4efee15c000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000005909f16ba61ea000000000000000000000000000000000000000000000000000000000010009046c000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000000408934ba230000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000111111125421ca6dc452d289314280a0f8842a65000000000000000000000000000000000000000000000005f68e8131ecf8000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000284e5af0ec8970683e243f600000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000007fc66500c84a76ad7e9c93437bfc5ac33e2ddae90000000000000000000000000000000000000000000000008bdef8a262cd97a0000000000000000000000000000000000000000000000005f68e8131ecf80000000000000000000000000000000099070700676506064e5b82dd926409dcdd6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000000400615dd8a432044cb3f8b6be6a252e22531fe037f20150b1f3f0587db5e93b4c1c1eec0a3d5626d6e77b646c69125d1afe87414b02d98a760654a2545db9e143f0000000000000000000000000000000000000000000000000000000000000014f081470f5c6fbccf48cc4e5b82dd926409dcdd67000000000000000000000000000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000f081470f5c6fbccf48cc4e5b82dd926409dcdd670000000000000000000000004e68ccd3e89f51c3074ca5072bbac773960dfa36000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000008be5449d77e4a8000000000000000000000000000000000000000000000000000000000100ad139c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000408934ba230000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000111111125421ca6dc452d289314280a0f8842a6500000000000000000000000000000000000000000000000796e3ea3f8ab00000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000034ddf6b4e80123e1ad56954100000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000007fc66500c84a76ad7e9c93437bfc5ac33e2ddae90000000000000000000000000000000000000000000000000000000a0a55824b00000000000000000000000000000000000000000000000796e3ea3f8ab00000000000000000000000000000000099070800676506064e5b82dd926409dcdd6700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000004045aca1b386296457a9063c8a9815d61865b8e9f63495924734d98adb8848cfdedd18bea266a606abc3d3b3ecc0de7f82f427c37ce7987a701c5141fa03f7e7c70000000000000000000000000000000000000000000000000000000000000014f081470f5c6fbccf48cc4e5b82dd926409dcdd67000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000025a03000000000000000000000023e1fb71ee0000000000000000000000007fc66500c84a76ad7e9c93437bfc5ac33e2ddae9000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000de6b2a06407575b98724818445178c1f5fd5336100000000000000000000000000000000000000000000001b1ae4d6e2ef50000000000000000000000000000000000000000000000000000000000023b47030c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000f081470f5c6fbccf48cc4e5b82dd926409dcdd67000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022c7b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a223135343432392e3934333535343637323138222c22416d6f756e744f7574555344223a223135343130322e3239393631313333383333222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22313534313231373135333239222c2254696d657374616d70223a313733343637333836352c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2261625a35544168536a36615871744634365a63773239345531585457537450595633746c666e7042665159706c45336347515a424a336a74492f544a6c47332f666230534e7657745275766354716d657974764176782f67464e2b545a2b364371484861514a7550792b5666756d4e694b71627279796f48584d47306a6831316f68552b626138776f36643263526d416539656979466f78756230446c373769345334702f4e2b4c7a6a4935625454386862524859364c44736a6d45537073754e41343278687934324b4d59347648546e6e57784a30666d796f77682b723866534d37704749534c3277506f506150456b4f435236324d614a594232734572566b7157566a397675795965634e6d6b335737343138374f5a557938426e6964637037375331556d6e78656b346152636276305332376f636534753241524d2b774950476a506f6c6f375331636b3565346b6d7a7652673d3d227d7d0000000000000000000000000000000000000000"; // Truncated for readability

        KyberRouterV2SwapDecoder.SwapExecutionParams memory params = KyberRouterV2SwapDecoder.swap(swapCalldata);
        
        // Verify decoded values
        assertEq(params.callTarget, 0xf081470f5C6FBCCF48cC4e5B82Dd926409DcdD67);
        assertEq(params.desc.srcToken, 0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9);
        assertEq(params.desc.dstToken, 0xdAC17F958D2ee523a2206206994597C13D831ec7);
        assertEq(params.desc.dstReceiver, 0xDe6b2a06407575B98724818445178C1f5fD53361);
        assertEq(params.desc.amount, 500000000000000000000);
    }

    function testSwapSimpleMode() public {
        // https://etherscan.io/tx/0x099858ab24f550f5d00bd7f5757a825be394c778727adc34da8fb341588b9d33
        bytes memory swapSimpleModeCalldata = hex"8af033fb0000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000006800000000000000000000000000f5c78f152152dda52a2ea45b0a8c10733010748000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000fab3353b8184d2384d6e1fcc3067a910c80348830000000000000000000000000000000000000000000037d89d77a7c46bf800000000000000000000000000000000000000000000000000000122beb6dc885132000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000067650a4c00000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a32f2cb7787696e75ffabeb6ebf88bdf72e65efe00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000037d89d77a7c46bf800000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004059361199000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000a32f2cb7787696e75ffabeb6ebf88bdf72e65efe0000000000000000000000000f5c78f152152dda52a2ea45b0a8c10733010748000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000060a4587899c58e7cc2e54303188f56acecaea477940000000000000000138800010000000000000000000000166ab21559000000000000000001560d8bd646052d00000000000000000000000048b8419b2bc0fb63ee96e3a370e30b200cc2e672000000000000000000000000000000000000000000000000000000000000022e7b22536f75726365223a22446566694c6c616d61222c22416d6f756e74496e555344223a223331362e363433373639383431303131222c22416d6f756e744f7574555344223a223332342e30373434313435363232353439222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a223936323739333336323831353732363532222c2254696d657374616d70223a313733343637333832302c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22546a536c3633746b73346a426973586b627a397a6f39546b4539787a323641644350633649486c5736304645465a657732386f4f642b48344b6f3466436d706a38766831314e3657756f62304a31585a774c66472f6375794f457763736b6e57684c5944704f4a71304a356b66374670366f492b764c306d752f356439357a597a2f4a707263567879344c45337638384f2b6f784d6541754e3071483131707a69437a496e4a463455454369356f2b4c5154446c4d5962314446354d6c36775542546a334f79615668394a585a4464696e457270564d4a4b526c755743373452424659456e47304634555932726354736b6933545a4d4e7833795657553137714966426c4f4f3632354f4458462b424a706546455a36682f54705645426a7371537665474361464e417469497749364f6d59763568786e772b4e4d506b4575573443434b30417665714e786854442b4b366d4c6153673d3d227d7d000000000000000000000000000000000000"; // Truncated for readability

        (
            address caller,
            KyberRouterV2SwapDecoder.SwapDescriptionV2 memory desc,
            bytes memory executorData,
            bytes memory clientData
        ) = KyberRouterV2SwapDecoder.swapSimpleMode(swapSimpleModeCalldata);

        // Verify decoded values
        assertEq(caller, 0x0F4A1D7FdF4890bE35e71f3E0Bbc4a0EC377eca3);
        assertEq(desc.srcToken, 0x0f5C78f152152dDA52a2ea45B0a8C10733010748);
        assertEq(desc.dstToken, 0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE);
    }
}